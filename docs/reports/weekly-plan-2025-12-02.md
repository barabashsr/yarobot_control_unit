# План работ на неделю

**Проект:** YaRobot Control Unit
**Период:** 2 — 6 декабря 2025
**Составлен:** 2 декабря 2025

---

## Цель недели

Завершить отладку прототипа и начать разработку firmware. Отладка hardware во вторник, разработка в четверг и пятницу.

---

## План по дням

### Вторник, 3 декабря

**Отладка прототипа**

| # | Задача | Описание |
|---|--------|----------|
| 1 | Проверка питания | Измерение напряжений 3.3V, 5V, 24V под нагрузкой |
| 2 | Проверка соединений | Прозвонка всех цепей согласно схеме |
| 3 | Тест шины I2C | Сканирование адресов MCP23017 (0x20, 0x21) |
| 4 | Тест шины SPI | Проверка связи с цепочкой shift registers |
| 5 | Тест OLED | Инициализация дисплея на I2C1 |
| 6 | Тест USB | Проверка USB CDC подключения к ПК |

**Критерий успеха:** Все шины работают, устройство определяется по USB, дисплей включается.

---

### Четверг, 5 декабря

**Эпик 1: Основа и инфраструктура** (7 историй)

| # | История | Описание |
|---|---------|----------|
| 1.1 | Инициализация проекта ESP-IDF | Создание проекта, sdkconfig, partitions.csv |
| 1.2 | Структура каталогов компонентов | Структура components/ согласно архитектуре |
| 1.3 | Каркас задач FreeRTOS | Базовые задачи, очереди, синхронизация |
| 1.4 | Заголовочные файлы конфигурации | Пины GPIO, константы, типы данных |
| 1.5 | Инфраструктура логирования | Уровни логирования, форматирование |
| 1.6 | Базовый HAL для I2C | Драйвер I2C для MCP23017 |
| 1.7 | Базовый HAL для SPI | Драйвер SPI для shift registers |

**Критерий успеха:** Проект компилируется, прошивается, логи выводятся в консоль.

---

### Пятница, 6 декабря

**Эпик 2: Коммуникации и командный интерфейс** (7 историй)

| # | История | Описание |
|---|---------|----------|
| 2.1 | Последовательный интерфейс USB CDC | USB-CDC драйвер, приём/передача данных |
| 2.2 | Основа парсера команд | Парсинг текстовых команд |
| 2.3 | Диспетчер команд | Маршрутизация команд к обработчикам |
| 2.4 | Форматирование ответов | Форматирование ответов |
| 2.5 | Система уведомлений о событиях | Асинхронные события |
| 2.6 | Управление режимами работы | Переключение режимов работы |
| 2.7 | История команд | История команд для отладки |

**Критерий успеха:** Устройство принимает команды через USB, отвечает на POS, STAT, INFO.

---

## Перенос на следующую неделю

**Эпик 3: Ядро управления моторами** (11 историй)

| # | История | Описание |
|---|---------|----------|
| 3.1 | Слой абстракции осей | Базовый интерфейс оси |
| 3.2 | Реализация серво-оси | STEP/DIR через RMT |
| 3.3 | Реализация шаговой оси | Шаговые оси с подсчётом позиции |
| 3.4 | Реализация дискретной оси | Дискретная ось E |
| 3.5 | Планировщик движения | Планирование траекторий |
| 3.6 | Команда MOVE | Абсолютное перемещение |
| 3.7 | Команда MOVR | Относительное перемещение |
| 3.8 | Команда JOG | Непрерывное движение |
| 3.9 | Команда STOP | Остановка движения |
| 3.10 | Управление включением/отключением | Управление ENABLE осей |
| 3.11 | Отслеживание позиции | Отслеживание позиции |

**Эпик 4: Безопасность и системы I/O** (14 историй)

| # | История | Описание |
|---|---------|----------|
| 4.1 | Драйвер MCP23017 | Драйвер I2C-расширителей |
| 4.2 | Мониторинг концевых выключателей | Мониторинг 14 концевиков |
| 4.3 | Обработчик E-Stop | Обработка аварийной остановки |
| 4.4 | Система управления тормозами | Управление тормозами |
| 4.5 | Действия по концевым выключателям | Реакция на срабатывание концевиков |
| 4.6 | Программные ограничения | Программные ограничения |
| 4.7 | Процедуры поиска дома | Процедуры homing |
| 4.8 | Входы общего назначения | 4 входа общего назначения |
| 4.9 | Выходы общего назначения | 8 выходов через shift register |
| 4.10 | Сигналы обратной связи серво | Чтение InPos, Alarm |
| 4.11 | Плавающий переключатель (ось C) | Измерение ширины объекта |
| 4.12 | Антидребезг входов | Антидребезг входов |
| 4.13 | Мониторинг аварий драйверов | Мониторинг аварий драйверов |
| 4.14 | Команда сброса аварий | Команда CLR для сброса аварий |

**Эпик 5: Конфигурация и отображение статуса** (12 историй)

| # | История | Описание |
|---|---------|----------|
| 5.1 | Парсер YAML | Парсинг YAML-конфигурации |
| 5.2 | Загрузчик конфигурации | Загрузка конфигурации при старте |
| 5.3 | Экспорт конфигурации | Экспорт текущей конфигурации |
| 5.4 | Изменение параметров в runtime | Изменение параметров без перезагрузки |
| 5.5 | Хранилище NVS | Сохранение калибровки в NVS |
| 5.6 | Сброс позиции | Команда сброса позиции |
| 5.7 | Коэффициенты масштабирования | Коэффициенты пересчёта |
| 5.8 | Псевдонимы осей | Пользовательские имена осей |
| 5.9 | Драйвер OLED-дисплея | Драйвер SSD1306 на I2C1 |
| 5.10 | Отображение статуса | Отображение позиций на OLED |
| 5.11 | Отображение ошибок | Отображение ошибок на OLED |
| 5.12 | Мониторинг состояния I2C | Мониторинг состояния I2C |

**Эпик 6: Расширенная обратная связь по позиции** (6 историй)

| # | История | Описание |
|---|---------|----------|
| 6.1 | Обработчик Z-сигнала | Чтение Z-сигнала энкодера |
| 6.2 | Обнаружение дрейфа позиции | Обнаружение дрейфа позиции |
| 6.3 | Отложенная коррекция | Отложенная коррекция позиции |
| 6.4 | Homing по Z-сигналу | Точное позиционирование по Z-сигналу |
| 6.5 | Мониторинг InPos | Мониторинг сигнала InPos |
| 6.6 | Обнаружение ошибок слежения | Обнаружение ошибок слежения |

---

## Зависимости

```
Эпик 1 ─┬─> Эпик 2 ─┬─> Эпик 3   (следующая неделя)
        │           │
        └─> Эпик 4 ─┘            (следующая неделя)
                    │
        Эпик 5 <────┘            (следующая неделя)
            │
            v
        Эпик 6                   (следующая неделя)
```

---

## Риски недели

| Риск | Вероятность | Митигация |
|------|-------------|-----------|
| Сложности с RMT-драйвером | Средняя | Резервный вариант через LEDC |
| Проблемы I2C на высокой скорости | Низкая | Понижение частоты до 100kHz |

---

## Ресурсы

- ESP-IDF v5.x Documentation
- MCP23017 Datasheet
- TPIC6B595N Datasheet
- Architecture Document (docs/architecture.md)

---

*План составлен: John, Product Manager*
