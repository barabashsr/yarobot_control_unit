# Отчёт о выполненных работах

**Проект:** YaRobot Control Unit
**Период:** 25 ноября — 1 декабря 2025
**Дата отчёта:** 2 декабря 2025

---

## Резюме

За отчётный период выполнены ключевые этапы проектирования: завершена проектная документация и разработана принципиальная схема устройства. Сборка прототипа находится на финальной стадии.

---

## О проекте

### Назначение

YaRobot Control Unit — универсальный контроллер управления моторами и актуаторами. Обеспечивает единый интерфейс для управления 8 осями различных типов (серво, шаговые, дискретные) через простые текстовые команды по USB.

### Аппаратная архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                      YaRobot Control Unit                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────┐      ┌────────────────────────────────┐ │
│  │   ESP32-S3 N16R8  │      │     Shift Registers (SPI)      │ │
│  │   (Main MCU)      │─SPI─▶│     5x TPIC6B595N (40 bit)     │ │
│  │                   │      │  DIR, ENABLE, BRAKE, ALM_CLR   │ │
│  │  - Dual Core      │      │  + 8 GP Outputs (5-50V)        │ │
│  │  - 16MB Flash     │      └────────────────────────────────┘ │
│  │  - 8MB PSRAM      │                                         │
│  │                   │      ┌────────────────────────────────┐ │
│  │  RMT/MCPWM/LEDC ──┼──────▶  STEP Signals (7 axes)         │ │
│  │  (Pulse Gen)      │      └────────────────────────────────┘ │
│  │                   │                                         │
│  │                   │      ┌────────────────────────────────┐ │
│  │         I2C0 ─────┼─────▶│  2x MCP23017 (I2C Expanders)   │ │
│  │                   │      │  - 14 Limit Switches           │ │
│  │                   │      │  - 7 ALARM_INPUT               │ │
│  │                   │      │  - 5 InPos signals             │ │
│  │                   │      └────────────────────────────────┘ │
│  │                   │                                         │
│  │         I2C1 ─────┼─────▶ SSD1306 OLED 128x64 (Status)     │ │
│  │                   │                                         │
│  │         USB ──────┼─────▶ Host PC (Commands/Events)        │ │
│  │                   │                                         │
│  │         GPIO ◀────┼───── E-STOP (Hardware interrupt)       │ │
│  └───────────────────┘                                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**Основные аппаратные блоки:**

| Блок | Компоненты | Назначение |
|------|------------|------------|
| MCU | ESP32-S3-DevKitC-1 N16R8 | Основной контроллер, генерация STEP-импульсов, USB-интерфейс |
| Shift Registers | 5x TPIC6B595N | Выходные сигналы (5-50V): DIR, ENABLE, BRAKE, ALARM_CLR, GPIO. Прямое управление оптоизолированными входами драйверов без дополнительных компонентов |
| I2C Expanders | 2x MCP23017 | Входные сигналы: концевики, аварии драйверов, InPos |
| Display | SSD1306 128x64 | Отображение статуса, позиций, ошибок |
| Power | LDO 3.3V/5V + 24V DC | Питание логики и выходных каскадов |

### Программная архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                    Application Layer                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ USB CDC     │  │ Command     │  │ Event Manager       │  │
│  │ Interface   │  │ Parser      │  │ (Pub/Sub)           │  │
│  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘  │
├─────────┼────────────────┼────────────────────┼─────────────┤
│         ▼                ▼                    ▼              │
│                    Control Layer                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ Motion      │  │ Safety      │  │ Config Manager      │  │
│  │ Controller  │  │ Monitor     │  │ (YAML + NVS)        │  │
│  └──────┬──────┘  └──────┬──────┘  └─────────────────────┘  │
├─────────┼────────────────┼──────────────────────────────────┤
│         ▼                ▼                                   │
│                    Motor Layer                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ Servo Axis  │  │ Stepper     │  │ Discrete Axis       │  │
│  │ (5 axes)    │  │ Axis (2)    │  │ (1 axis)            │  │
│  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘  │
├─────────┼────────────────┼────────────────────┼─────────────┤
│         ▼                ▼                    ▼              │
│                      HAL Layer                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ RMT/MCPWM   │  │ SPI (Shift  │  │ I2C (MCP23017)      │  │
│  │ (Pulses)    │  │ Registers)  │  │                     │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

**Ключевые принципы:**

- **Dual-core разделение:** Core 0 — коммуникации и безопасность, Core 1 — управление движением
- **FreeRTOS:** Детерминированное выполнение задач с приоритетами
- **Аппаратная генерация импульсов:** RMT+DMA обеспечивает до 100 kHz без нагрузки на CPU
- **Fail-safe:** Тормоза включаются при потере питания, E-STOP работает аппаратно

---

## Выполненные работы

### 1. Проектная документация

**Статус:** Завершено

Разработана полная проектная документация проекта:

- **PRD (Product Requirements Document)** — определены функциональные требования (70 FR), нефункциональные требования, границы MVP и перспективные функции
- **Architecture Document** — проработана архитектура системы, распределение GPIO, структура компонентов ESP-IDF
- **Epics & Stories** — требования декомпозированы на 6 эпиков и 57 пользовательских историй

**Итерации документации:**
- Проведено несколько итераций валидации документов
- Выполнена cross-check согласованность ТЗ и архитектуры
- Созданы отчёты валидации (3 документа)
- Принято решение по конфигурации концевых выключателей (end-switch-decisions.md)

### 2. Разработка принципиальной схемы

**Статус:** Завершено

В среде KiCad разработана принципиальная схема устройства ya_brakeboardESP32_S3:

- **Основная схема** — ESP32-S3 DevKitC-1 N16R8, разводка сигналов
- **MCP23017** — схема подключения двух I2C-расширителей для входных сигналов (концевики, аварии, InPos)
- **Shift Registers** — цепочка из 5x TPIC6B595N для управляющих выходов (DIR, ENABLE, BRAKE, ALARM_CLEAR, GPIO)
- **Power Supply** — схема питания 3.3V/5V/24V

Схема соответствует архитектурной документации и обеспечивает:
- Управление 8 осями (5 серво + 2 степпера + 1 дискретная)
- 14 входов концевых выключателей
- 8 выходов общего назначения
- Сигналы STEP через RMT/MCPWM периферии ESP32-S3

### 3. Сборка прототипа

**Статус:** В процессе (~90% готовности)

- Подготовлены компоненты согласно BOM
- Выполнена основная сборка на макетной плате


**Осталось:**
- Первичная проверка питания
- Финальная проверка соединений
- Подключение к тестовому стенду

---

## Ключевые решения

| Решение | Обоснование |
|---------|-------------|
| TPIC6B595N вместо GPIO-expanders для выходов | Широкий диапазон напряжений (5-50V), прямое управление оптоизолированными входами драйверов |
| Отдельная шина I2C для OLED-дисплея | Изоляция от критичных I/O, повышение надёжности |
| Использование RMT+DMA для STEP-сигналов | Аппаратная генерация импульсов до 100 kHz |

---

## Риски и проблемы

| Риск | Статус | Митигация |
|------|--------|-----------|
| Ограничение GPIO ESP32-S3 | Решено | Shift registers + I2C expanders |
| Сложность синхронизации 8 осей | Открыт | Заложено в архитектуре FreeRTOS |

---

## Следующие шаги

1. Завершение сборки прототипа
2. Начало разработки firmware (Epic 1: Foundation & Infrastructure)
3. Тестирование I2C-коммуникации с MCP23017
4. Верификация работы shift register chain

---

*Отчёт подготовлен: John, Product Manager*
