# План работ на неделю

**Проект:** YaRobot Control Unit
**Период:** 9 — 13 декабря 2025
**Составлен:** 9 декабря 2025

---

## Цель недели

Завершить Эпик 3 (Ядро управления моторами) и выполнить Эпики 4 и 5. Работа запланирована на три дня: вторник, четверг и пятница.

---

## План по дням

### Вторник, 10 декабря

**Эпик 3: Ядро управления моторами — завершение**

| # | История | Описание | Статус |
|---|---------|----------|--------|
| 3.9 | Контроллер движения и CMD_MOVE/CMD_MOVR | Абсолютное и относительное перемещение | Ревью → Готово |
| 3.9b | Интеграция моторной системы | Интеграция всех осей | Ревью → Готово |
| 3.10 | CMD_VEL, CMD_STOP, CMD_EN, CMD_POS | Непрерывное движение, остановка, включение | Ревью → Готово |
| 3.11 | События завершения движения | EVENT DONE, EVENT LIMIT | Бэклог → Готово |

**Критерий успеха:** Все команды движения работают (MOVE, MOVR, VEL, STOP, EN, POS). События завершения генерируются.

---

### Четверг, 12 декабря

**Эпик 4: Безопасность и системы I/O (14 историй)**

| # | История | Описание |
|---|---------|----------|
| 4.1 | Драйвер MCP23017 I/O-расширителя | Драйвер для 2x MCP23017 с прерываниями |
| 4.2 | Мониторинг концевых выключателей | Чтение 14 концевиков через MCP23017 #0 |
| 4.3 | Остановка движения по концевикам | Немедленная остановка при срабатывании |
| 4.4 | Система аварийной остановки (E-Stop) | Аппаратный E-Stop с отключением всех осей |
| 4.5 | Система управления тормозами | Стратегии тормозов: ON_DISABLE, ON_ESTOP |
| 4.6 | Обнаружение потери позиции | Детекция рассинхронизации позиции |
| 4.7 | Цифровые I/O общего назначения | 4 входа (MCP23017), 8 выходов (Shift Reg) |
| 4.8 | Обработка сигналов серво (InPos) | Чтение InPos с MCP23017 #1 |
| 4.9 | Плавающий переключатель оси C | Измерение ширины объекта |
| 4.10 | Отслеживание и восстановление ошибок | Подсчёт ошибок, команда CLR |
| 4.11 | Мониторинг I2C-соединения | Проверка здоровья шины I2C |
| 4.12 | Логирование ошибок | Журнал ошибок в RAM |
| 4.13 | Процедуры хоминга | Команда HOME с поиском концевика |
| 4.14 | Мониторинг аварий драйверов | Чтение ALARM_INPUT, команда CLR |

**Критерий успеха:** Концевики читаются, E-Stop работает, тормоза управляются, HOME выполняется.

---

### Пятница, 13 декабря

**Эпик 5: Конфигурация и отображение статуса (12 историй)**

| # | История | Описание |
|---|---------|----------|
| 5.1 | Интеграция YAML-парсера | Парсинг YAML-конфигурации |
| 5.2 | Загрузка конфигурации (CFGSTART/CFGDATA/CFGEND) | Загрузка конфигурации по USB |
| 5.3 | Экспорт конфигурации (CFGEXPORT) | Выгрузка текущей конфигурации |
| 5.4 | Изменение параметров в runtime (SET) | Изменение параметров без перезагрузки |
| 5.5 | Хранение конфигурации в NVS (SAVE/LOAD) | Сохранение калибровки |
| 5.6 | Сброс позиции (CLR) | Обнуление позиции без движения |
| 5.7 | Конфигурация коэффициентов масштабирования | pulses_per_unit, units |
| 5.8 | Псевдонимы осей (ALIAS) | Пользовательские имена осей |
| 5.9 | Драйвер OLED-дисплея | SSD1306 на I2C1 |
| 5.10 | Задача отображения статуса | Позиции, статус движения на OLED |
| 5.11 | Расширенный запрос статуса | Расширенный STAT с фильтрами |
| 5.12 | Команды валидации конфигурации | Проверка конфигурации |

**Критерий успеха:** OLED отображает позиции, конфигурация загружается/сохраняется, SET работает.

---

## Детали по историям эпиков

### Эпик 3: Ядро управления моторами

**Функциональные требования:** FR1-FR10, FR43-FR44, FR48

| FR | Описание |
|----|----------|
| FR1 | Управление 8 независимыми осями (X,Y,Z,A,B,C,D,E) |
| FR2 | Генерация STEP-импульсов до 500 кГц |
| FR3 | Управление 5 серво через STEP/DIR |
| FR4 | Управление 2 шаговыми моторами с аппаратным подсчётом |
| FR5 | Управление 1 дискретным актуатором (ось E) |
| FR6 | Абсолютное перемещение (MOVE) |
| FR7 | Относительное перемещение (MOVR) |
| FR8 | Непрерывное движение (VEL/JOG) |
| FR9 | Немедленная остановка (STOP) |
| FR10 | Включение/отключение осей (EN) |
| FR43 | Отчёт о позиции в реальном времени |
| FR44 | Отчёт о статусе движения |
| FR48 | События завершения движения |

---

### Эпик 4: Безопасность и системы I/O

**Функциональные требования:** FR11-FR18, FR33, FR35-FR42, FR45, FR49, FR56-FR64

| FR | Описание |
|----|----------|
| FR11 | Мониторинг 14 концевых выключателей |
| FR12 | Аппаратный E-Stop |
| FR13 | Автоматическая остановка по концевикам |
| FR14 | Управление тормозами с настраиваемыми стратегиями |
| FR15 | Fail-safe включение тормозов при потере питания |
| FR16 | Обнаружение потери позиции |
| FR17 | Программные ограничения |
| FR18 | Настройка полярности концевиков |
| FR33 | Процедуры хоминга |
| FR35 | 4 цифровых входа |
| FR36 | 8 цифровых выходов |
| FR37 | Обработка сигналов серво (InPos, Alarm) |
| FR38-40 | Плавающий переключатель оси C |
| FR41 | Антидребезг входов |
| FR42 | Имена/псевдонимы пинов |
| FR45 | Счётчики ошибок |
| FR49 | События ошибок |
| FR56-61 | Обработка ошибок I2C |
| FR62-64 | Мониторинг и сброс аварий драйверов |

---

### Эпик 5: Конфигурация и отображение статуса

**Функциональные требования:** FR27-FR32, FR34, FR46-FR47c, FR50

| FR | Описание |
|----|----------|
| FR27 | Загрузка конфигурации из YAML через USB |
| FR28 | Экспорт конфигурации в YAML |
| FR29 | Изменение параметров в runtime |
| FR30 | Сохранение калибровки в NVS |
| FR31 | Сброс позиции без движения |
| FR32 | Коэффициенты масштабирования |
| FR34 | Псевдонимы осей |
| FR46 | Мониторинг I2C |
| FR47 | OLED-дисплей с позициями |
| FR47a | E-Stop на дисплее с высшим приоритетом |
| FR47b | Ошибки на дисплее 2 секунды |
| FR47c | Отдельная шина I2C для OLED |
| FR50 | Запрос статуса отдельных осей |

---

## Зависимости

```
Эпик 3 (завершение) ──> Эпик 4 ──> Эпик 5
     (вторник)       (четверг)  (пятница)
                          │
                          v
                     Эпик 6 (следующая неделя)
```

---

## Риски недели

| Риск | Вероятность | Митигация |
|------|-------------|-----------|
| Большой объём Эпика 4 (14 историй) | Высокая | Приоритизация критичных (E-Stop, концевики) |
| Сложности с прерываниями MCP23017 | Средняя | Fallback на polling (5мс) |
| Ограниченное время на OLED | Средняя | Базовый вывод позиций, остальное — MVP+ |

---

## Ресурсы

- ESP-IDF v5.x Documentation
- MCP23017 Datasheet (I2C Expander)
- SSD1306 OLED Driver
- Architecture Document (docs/architecture.md)
- Epic Breakdown (docs/epics.md)

---

*План составлен: John, Product Manager*
