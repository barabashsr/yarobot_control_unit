# Sprint Change Proposal: RMT Pulse Generator FastAccelStepper Refactor

**Document Type:** Sprint Change Proposal
**Date:** 2025-12-06
**Generated By:** PM Agent (John) via correct-course workflow
**Status:** Approved

---

## 1. Issue Summary

### Problem Statement

The RMT pulse generator DMA streaming architecture (implemented in Story 3.2) causes channel exhaustion when attempting to operate all 4 RMT axes (X, Z, A, B) simultaneously. The current design also lacks mid-motion blending capability required by the PRD.

### Context

- **Triggering Story:** Story 3.2 (RMT Pulse Generator) - marked DONE
- **Discovery:** Issues surfaced during motor system integration (Story 3.9b)
- **Issue Type:** Technical limitation discovered during implementation

### Evidence

1. **Channel Exhaustion Error:** `rmt_tx_register_to_group: no free tx channels`
2. **Hardware Constraint:** ESP32-S3 has only 4 PCNT units (3 already allocated to Y, C, D axes)
3. **PRD Requirement:** Position queryable with <10ms latency
4. **PRD Requirement:** Mid-motion blending for smooth operation

---

## 2. Impact Analysis

### Epic Impact

| Epic | Impact Level | Details |
|------|--------------|---------|
| Epic 3: Motor Control Core | Minor | Add Story 3-9c for refactor |
| Epic 4: Safety & I/O Systems | None | Uses IPulseGenerator interface |
| Epic 5: Configuration & Status | None | No dependency on RMT internals |
| Epic 6: Advanced Position Feedback | None | Uses position tracker interface |

### Story Impact

| Story | Impact | Action |
|-------|--------|--------|
| 3.2 (RMT Pulse Generator) | None | Stays DONE - met original AC |
| 3.9 (Motion Controller) | None | In review, uses interface |
| 3.9b (Motor System Integration) | None | In review, uses interface |
| 3.10-3.11 (Backlog) | None | Will use refactored impl |

### Artifact Conflicts

| Artifact | Conflict | Resolution |
|----------|----------|------------|
| PRD | None | Requirements still achievable |
| Architecture.md | Deferred | Update AFTER implementation (per user request) |
| config_limits.h | Update needed | Part of Story 3-9c |
| config_timing.h | Update needed | Part of Story 3-9c |
| IPulseGenerator interface | None | Interface UNCHANGED |

### Technical Impact

- **Code:** RmtPulseGenerator class refactored (complete rewrite of internals)
- **Tests:** Existing tests should pass (interface unchanged)
- **New tests:** 4-channel simultaneous operation test added
- **Infrastructure:** No deployment/CI changes needed

---

## 3. Recommended Approach

### Selected Path: Direct Adjustment

Add new Story 3-9c within existing Epic 3 structure.

### Rationale

1. **Minimal Disruption:** Story 3.2 met its original acceptance criteria and remains DONE
2. **Clean History:** New story clearly documents the architectural improvement
3. **No Interface Changes:** Downstream stories (3.9, 3.9b, 3.10+) unaffected
4. **Comprehensive Reference:** Migration strategy document provides complete implementation guide

### Alternatives Considered

| Option | Verdict | Reason |
|--------|---------|--------|
| Reopen Story 3.2 | Rejected | Muddles history, original AC were met |
| Tech Debt Item | Rejected | This is a planned improvement, not debt |
| New Epic | Rejected | Scope doesn't warrant separate epic |

### Effort Estimate

- **Level:** Medium
- **Tasks:** 8 implementation tasks
- **Complexity:** Substantial code refactor, but well-documented strategy

### Risk Assessment

- **Level:** Low
- **Mitigating Factors:**
  - IPulseGenerator interface unchanged
  - Existing tests provide regression coverage
  - Comprehensive migration strategy document exists
  - No external dependencies introduced

---

## 4. Detailed Change Proposals

### Change 1: New Story File

**File:** `docs/sprint-artifacts/3-9c-rmt-fastaccelstepper-refactor.md`

**Status:** Created

**Content Summary:**
- 7 acceptance criteria covering multi-channel operation, position latency, mid-motion blending
- 8 implementation tasks aligned with migration strategy phases
- ISR safety requirements documented
- References to migration strategy document

### Change 2: Sprint Status Update

**File:** `docs/sprint-artifacts/sprint-status.yaml`

**Change:**
```yaml
# Before
3-9b-motor-system-integration: review
3-10-cmd-vel-stop-en-pos: backlog

# After
3-9b-motor-system-integration: review
3-9c-rmt-fastaccelstepper-refactor: drafted
3-10-cmd-vel-stop-en-pos: backlog
```

**Status:** Applied

### Change 3: Architecture Document (DEFERRED)

**File:** `docs/architecture.md`

**Action:** Update AFTER implementation completes (per user request)

**Sections to update:**
- RMT configuration (16 MHz resolution, callback encoder)
- Position tracking strategy (encoder callback vs PCNT)
- Task architecture (per-axis ramp tasks)

---

## 5. Implementation Handoff

### Scope Classification: Minor

This change can be implemented directly by the development team without backlog reorganization or architectural review.

### Handoff Recipients

| Role | Responsibility |
|------|----------------|
| Dev Agent | Implement Story 3-9c per migration strategy |
| SM Agent | Review implementation, run code-review workflow |
| PM Agent | Verify PRD requirements met post-implementation |

### Deliverables

1. **Story File:** `docs/sprint-artifacts/3-9c-rmt-fastaccelstepper-refactor.md`
2. **Reference Document:** `docs/architecture-changes/fastaccelstepper-migration-strategy.md`
3. **Sprint Status:** Updated with new story

### Success Criteria

1. All 4 RMT axes operate simultaneously at 200kHz without errors
2. Position query latency <10ms at all frequencies
3. Mid-motion blending works (startMove() callable while running)
4. All existing IPulseGenerator tests pass
5. Hardware verification confirms no channel interference

### Next Steps

1. Generate story context via story-context workflow
2. Move story to `ready-for-dev` status
3. Implement per migration strategy document phases
4. Run code-review workflow on completion
5. Update architecture.md after implementation verified

---

## Approval

**Approved By:** Sergey (User)
**Approval Date:** 2025-12-06
**Approval Method:** Incremental review via correct-course workflow

---

## Change Log

| Date | Author | Change |
|------|--------|--------|
| 2025-12-06 | PM Agent (John) | Initial proposal created via correct-course workflow |
